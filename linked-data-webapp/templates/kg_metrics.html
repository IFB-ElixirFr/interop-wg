{% extends "layout.html" %}

{% block nav %}
{% include 'nav.html' %}
{% endblock %}

{% block body %}

<script type="text/javascript" charset="utf-8">

    $( document ).ready(function() {

<!--        var cm = new CodeMirror.fromTextArea(document.getElementById("editor"), {-->
<!--            lineNumbers: true,-->
<!--            lineWrapping: true,-->
<!--         });-->

        console.log( "ready!" );
        $("#notif").addClass("is-hidden");

        console.log('trying to connect...');
        var socket = io.connect('http://127.0.0.1:5000');
        //var socket = io();
        console.log('connected');

        //////////////////
        // click handlers
        //////////////////

        {% for f in f_metrics %}
            $("#test_{{f.id}}").click(function(){
                console.log("Testing metric {{f.name}}");
                console.log("ID: " + "{{f.id}}");
                console.log("Value: " + "{{f.api_url}}");
                $(this).addClass("is-loading");

                socket.emit('retrieve_embedded_annot', {
                              url: $("#url").val()
                });
            });
        {% endfor %}

        {% for k in sample_data.keys() %}
            $("#sample_{{k}}").on("change", function(){
                console.log(this.value) ;
                $("#url").val(this.value) ;
                $('#sample_{{k}} option[value="{{ k }}"]').attr("selected", "selected");
            });
        {% endfor %}

        $("#btn_kg").click(function(){
            $(this).addClass("is-loading");
            socket.emit('retrieve_embedded_annot', {url: $("#url").val()});
        });

        $("#btn_fairness").click(function(){
            $(this).addClass("is-loading");
            socket.emit('check_kg', {url: $("#url").val()});
        });

        //////////////////
        // event handlers
        //////////////////

        socket.on('connect', function() {
            socket.emit('hello', {data: 'I\'m connected!'});
            console.log('hello message sent');
        });

         socket.on('update_annot', function(value) {
             if ("done".includes(value)) {
                $("#p1").attr("value", 4);
            } else {
                console.log('received '+value+' for p1');
                $("#p1").attr("value",value);
            }
         });
         socket.on('send_annot', function(value) {
             console.log(value);
             //cm.setValue(value);
             $("#microdata").val(value)
             $("#btn_kg").removeClass("is-loading");
         });

        socket.on('done_check', function(value) {
            console.log(value);
            var rows = '';
            $.each(value['classes'], function(index, item) {
                var row = '<tr>';
                row += '<td>' + item + '</td>';
                rows += row + '<tr>';
            });
            $('#t_classes').html(rows);

            var rows = '';
            $.each(value['properties'], function(index, item) {
                var row = '<tr>';
                row += '<td>' + item + '</td>';
                rows += row + '<tr>';
            });
            $('#t_properties').html(rows);

             $("#btn_fairness").removeClass("is-loading");
         });

        {% for f in f_metrics %}
        socket.on('done_{{f.id}}', function(value) {
            console.log('DONE {{f.name}}');
            $("#test_{{f.id}}").removeClass("is-loading");

            console.log(value['score']);
            if (value['score'] == 1) {
              $("#status_{{f.id}}").addClass("is-success");
            } else {
              $("#status_{{f.id}}").addClass("is-danger");
            }
            console.log(value['comment']);

        });
        {% endfor %}

        socket.on('fast', function(value) {
            if ("done".includes(value)) {
                $("#p1").attr("value", 100);
            } else {
                console.log('received '+value+' for p1');
                $("#p1").attr("value",value);
            }
        });

        socket.on('slow', function(value) {
            if ("done".includes(value)) {
                $("#p2").attr("value", 100);
            } else {
                console.log('received '+value+' for p2');
                $("#p2").attr("value", value);
            }
        });

        socket.on('long', function(value) {
            console.log('END LONG');
            $("#notif").text(value);
            $("#notif").removeClass("is-hidden");
        });

        //socket.emit('fast');

    });
</script>

<h1 class="title">How FAIR is my resource</h1>
<p> Bla bla bla bla </p>

<h3 class="title is-5">Pick a sample resource identifier</h3>
<div class="columns is-multiline is-mobile">
    {% for k in sample_data.keys() %}
        <div class="column is-2">
            <div class="field">
                <label class="label">{{k}}</label>
                <div class="control">

                    <div class="select">
                        <select id="sample_{{k}}">
                            {% for s in sample_data[k] %}
                            <option>{{ s }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<div class="section">
    <progress id="p1" class="progress is-primary"  value="0" max="5"></progress>
</div>

<div class="section">

    <div class="field is-grouped">
          <p class="control is-expanded">
            <input id="url" name="url" class="input" type="text" placeholder="Resource URL" value="http://bio.tools/bwa">
          </p>
        <p class="control"><a id="btn_kg" class="button is-info">Build KG</a></p>
        <p class="control"><a id="btn_fairness" class="button is-primary">Check FAIRness</a></p>
    </div>
</div>

<!--<div class="section">-->
<!--    <textarea id="editor"></textarea>-->
<!--</div>-->
<div class="section">
    <div class="field">
      <div class="control">
        <textarea id="microdata" class="textarea is-small" placeholder="Small textarea"></textarea>
      </div>
    </div>
</div>

<div class="columns is-multiline is-mobile">
<!--    <div class="column is-one-fifth"><code>Findable</code></div>-->
    {% for f in f_metrics %}
        <div class="column is-one-third">
            {% set title=f.name %}
            {% set principle=f.principle %}
            {% set tag=f.principle_tag %}
            {% set desc=f.description %}
            {% set api_url=f.api_url %}
            {% set id=f.id %}
            {% include 'metrics_card.html' with context %}
        </div>
    {% endfor %}
</div>
<!--<div class="columns is-multiline is-mobile">-->
<!--    <div class="column is-one-quarter"><code>A1</code></div>-->
<!--    <div class="column is-one-quarter"><code>A2</code></div>-->
<!--    <div class="column is-one-quarter"><code>A3</code></div>-->
<!--</div>-->
<!--<div class="columns is-multiline is-mobile">-->
<!--    <div class="column is-one-quarter"><code>I1</code></div>-->
<!--</div>-->
<!--<div class="columns is-multiline is-mobile">-->
<!--    <div class="column is-one-quarter"><code>R1</code></div>-->
<!--    <div class="column is-one-quarter"><code>R2</code></div>-->
<!--</div>-->

<div class="columns is-multiline is-mobile">
    <div class="column is-one-half">
        <table class="table is-striped is-fullwidth">
            <thead><tr><th>Classes</th></tr></thead>
            <tbody id="t_classes">
            </tbody>
        </table>
    </div>
    <div class="column is-one-half">
        <table class="table is-striped is-fullwidth">
            <thead><tr><th>Properties</th></tr></thead>
            <tbody id="t_properties">
            </tbody>
        </table>
    </div>
</div>

{% endblock %}
